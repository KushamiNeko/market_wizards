{{define "TransactionNewJS"}}

<script>
  $(".invalid-feedback").hide();

  var buy = true;
  var sell = false;

  var decimal = 2;

  $("#button-type").click(function() {
    buy = !buy;
    sell = !buy;

    if (buy) {
      $("#button-type").html("BUY");
    }

    if (sell) {
      $("#button-type").html("SELL");
    }
  });

  function calculate() {
    if ($("#input-price").val().match(/^[0-9.]+$/) === null) {
      return;
    }

    if ($("#input-share").val().match(/^\d+$/) === null) {
      return;
    }

    var price = parseFloat($("#input-price").val());
    var share = parseFloat($("#input-share").val());

    var total = (price * share).toFixed(decimal);

    $("#input-total").val(total.toString());

    if ($("#input-capital").val().match(/^[0-9.]+$/) === null) {
      return;
    }

    var capital = parseFloat($("#input-capital").val());
    var position = ((total / capital) * 100).toFixed(decimal);

    $("#input-position").val(position.toString());
  }

  $("#input-price").focusout(function() {
    calculate();
  });

  $("#input-share").focusout(function() {
    calculate();
  });

  $("#input-capital").focusout(function() {
    calculate();
  });

  $("#button-create").click(function() {
    $(".invalid-feedback").hide();

    if ($("#input-date").val().match(/^\d{8}$/) === null) {
      $("#validate-date").show();
      return;
    }

    var date = parseInt($("#input-date").val());

    if ($("#input-symbol").val().toUpperCase().match(/^[A-Z]+$/) === null) {
      $("#validate-symbol").show();
      return;
    }

    var symbol = $("#input-symbol").val().toUpperCase();

    if ($("#input-capital").val().match(/^[0-9.]+$/) === null) {
      $("#validate-capital").show();
      return;
    }

    var capital = parseFloat($("#input-capital").val());

    if ($("#input-price").val().match(/^[0-9.]+$/) === null) {
      $("#validate-price").show();
      return;
    }

    var price = parseFloat($("#input-price").val());

    if ($("#input-share").val().match(/^\d+$/) === null) {
      $("#validate-share").show();
      return;
    }

    var share = parseInt($("#input-share").val());

    var total = parseFloat($("#input-total").val());

    var position = parseFloat($("#input-position").val());

    if ($("#input-stage").val().match(/^\d+$/) === null) {
      $("#validate-stage").show();
      return;
    }

    var stage = parseInt($("#input-stage").val());

    var note = $("#input-note").val();

    if ($("#img-ibd").attr("src") === undefined) {
      $("#validate-img-ibd").show();
      return;
    }

    if ($("#img-d").attr("src") === undefined) {
      $("#validate-img-d").show();
      return;
    }

    if ($("#img-w").attr("src") === undefined) {
      $("#validate-img-w").show();
      return;
    }

    if ($("#img-ndqc-d").attr("src") === undefined) {
      $("#validate-img-ndqc-d").show();
      return;
    }

    if ($("#img-ndqc-w").attr("src") === undefined) {
      $("#validate-img-ndqc-w").show();
      return;
    }

    if ($("#img-sp5-d").attr("src") === undefined) {
      $("#validate-img-sp5-d").show();
      return;
    }

    if ($("#img-sp5-w").attr("src") === undefined) {
      $("#validate-img-sp5-w").show();
      return;
    }

    if ($("#img-djia-d").attr("src") === undefined) {
      $("#validate-img-djia-d").show();
      return;
    }

    if ($("#img-djia-w").attr("src") === undefined) {
      $("#validate-img-djia-w").show();
      return;
    }

    if ($("#img-rus-d").attr("src") === undefined) {
      $("#validate-img-rus-d").show();
      return;
    }

    if ($("#img-rus-w").attr("src") === undefined) {
      $("#validate-img-rus-w").show();
      return;
    }

    var data = {
      "Date": date,
      "Symbol": symbol,
      "Capital": capital,
      "Price": price,
      "Share": share,
      "Total": total,
      "Position": position,
      "Stage": stage,
      "Note": note,
      "JsonChartD": $("#img-d").attr("src"),
      "JsonChartW": $("#img-w").attr("src"),
      "JsonChartNDQCD": $("#img-ndqc-d").attr("src"),
      "JsonChartNDQCW": $("#img-ndqc-w").attr("src"),
      "JsonChartSP5D": $("#img-sp5-d").attr("src"),
      "JsonChartSP5W": $("#img-sp5-w").attr("src"),
      "JsonChartNYCD": $("#img-nyc-d").attr("src"),
      "JsonChartNYCW": $("#img-nyc-w").attr("src"),
      "JsonChartDJIAD": $("#img-djia-d").attr("src"),
      "JsonChartDJIAW": $("#img-djia-w").attr("src"),
      "JsonChartRUSD": $("#img-rus-d").attr("src"),
      "JsonChartRUSW": $("#img-rus-w").attr("src"),
      "JsonIBDCheckup": $("#img-ibd").attr("src"),
    };

    var jsonBody = JSON.stringify(data);

    $.ajax({
      type: "POST",
      url: "/transaction",
      data: jsonBody,
      success: function(data) {
        window.location = data;
      },
      error: function(xhr, err) {
        console.log(err);
      },
    });
  });

  function imgChange(target) {
    var button = "#button-img-" + target;
    var inputs = "#input-img-" + target;
    var img = "#img-" + target;

    $(button).click(function() {
      $(inputs).click();
    });

    $(inputs).change(function() {
      fileChanged($(inputs), $(img));
    });
  }

  imgChange("d");
  imgChange("w");

  imgChange("ndqc-d");
  imgChange("ndqc-w");

  imgChange("sp5-d");
  imgChange("sp5-w");

  imgChange("nyc-d");
  imgChange("nyc-w");

  imgChange("djia-d");
  imgChange("djia-w");

  imgChange("rus-d");
  imgChange("rus-w");

  imgChange("ibd");
</script>

{{end}}
