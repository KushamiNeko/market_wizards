{{define "TransactionNewJS"}}

<script>
  $(".invalid-feedback").hide();

  var buy = true;
  var sell = false;

  var decimal = 2;

  var processing = false;

  $("#button-type").click(function() {
    buy = !buy;
    sell = !buy;

    if (buy) {
      $("#button-type").html("BUY");
      $("#input-cost").attr("disabled", "disabled");
      $("#input-dayhold").attr("disabled", "disabled");
    }

    if (sell) {
      $("#button-type").html("SELL");
      $("#input-cost").removeAttr("disabled");
      $("#input-dayhold").removeAttr("disabled");
    }

    $("#input-revenue").val("");
    $("#input-cost").val("");
    $("#input-profit").val("");
    $("#input-gain").val("");
    $("#input-dayhold").val("");

    calculate();
  });

  function calculate() {
    if ($("#input-price").val().match(/^[0-9.]+$/) === null) {
      return;
    }

    if ($("#input-share").val().match(/^\d+$/) === null) {
      return;
    }

    var price = parseFloat($("#input-price").val());
    var share = parseFloat($("#input-share").val());

    var total = (price * share).toFixed(decimal);

    var revenue = 0;
    var cost = 0;
    var profit = 0;
    var gain = 0;

    if (buy) {
      $("#input-cost").val(total.toString());
      cost = total;
    }

    if (sell) {
      $("#input-revenue").val(total.toString());
      revenue = total;
    }

    if (sell) {
      if ($("#input-cost").val().match(/^[0-9.]+$/) === null) {
        return;
      }

      cost = parseFloat($("#input-cost").val());

      profit = (revenue - cost).toFixed(decimal);
      $("#input-profit").val(profit.toString());

      gain = ((profit / cost) * 100).toFixed(decimal);

      $("#input-gain").val(gain.toString());
    }

  }

  $("#input-price").focusout(function() {
    calculate();
  });

  $("#input-share").focusout(function() {
    calculate();
  });

  $("#input-cost").focusout(function() {
    calculate();
  });

  $("#button-create").click(function() {
    $(".invalid-feedback").hide();

    if (processing) {
      return;
    }

    if ($("#input-date").val().match(/^\d{8}$/) === null) {
      $("#validate-date").show();
      return;
    }

    var date = parseInt($("#input-date").val());

    if ($("#input-symbol").val().toUpperCase().match(/^[A-Z]+$/) === null) {
      $("#validate-symbol").show();
      return;
    }

    var symbol = $("#input-symbol").val().toUpperCase();

    if ($("#input-price").val().match(/^[0-9.]+$/) === null) {
      $("#validate-price").show();
      return;
    }

    var price = parseFloat($("#input-price").val());

    if ($("#input-share").val().match(/^\d+$/) === null) {
      $("#validate-share").show();
      return;
    }

    var share = parseInt($("#input-share").val());

    var revenue = parseFloat($("#input-revenue").val());

    var cost = parseFloat($("#input-cost").val());

    var profit = parseFloat($("#input-profit").val());

    var gain = parseFloat($("#input-gain").val());

    if ($("#input-stage").val().match(/^\d+$/) === null) {
      $("#validate-stage").show();
      return;
    }

    var stage = parseInt($("#input-stage").val());

    if (sell) {
      if ($("#input-dayhold").val().match(/^[0-9]+$/) === null) {
        $("#validate-dayhold").show();
        return;
      }
    }

    var dayhold = parseInt($("#input-dayhold").val());

    var note = $("#input-note").val();

    if ($("#img-ibd").attr("src") === undefined) {
      $("#validate-img-ibd").show();
      return;
    }

    if ($("#img-d").attr("src") === undefined) {
      $("#validate-img-d").show();
      return;
    }

    if ($("#img-w").attr("src") === undefined) {
      $("#validate-img-w").show();
      return;
    }

    if ($("#img-ndqc-d").attr("src") === undefined) {
      $("#validate-img-ndqc-d").show();
      return;
    }

    if ($("#img-ndqc-w").attr("src") === undefined) {
      $("#validate-img-ndqc-w").show();
      return;
    }

    if ($("#img-sp5-d").attr("src") === undefined) {
      $("#validate-img-sp5-d").show();
      return;
    }

    if ($("#img-sp5-w").attr("src") === undefined) {
      $("#validate-img-sp5-w").show();
      return;
    }

    if ($("#img-djia-d").attr("src") === undefined) {
      $("#validate-img-djia-d").show();
      return;
    }

    if ($("#img-djia-w").attr("src") === undefined) {
      $("#validate-img-djia-w").show();
      return;
    }

    if ($("#img-rus-d").attr("src") === undefined) {
      $("#validate-img-rus-d").show();
      return;
    }

    if ($("#img-rus-w").attr("src") === undefined) {
      $("#validate-img-rus-w").show();
      return;
    }

    var data = {
      "Date": date,
      "Symbol": symbol,
      "Price": price,
      "Share": share,
      "Cost": cost,
      "Stage": stage,
      "Note": note,
      "JsonChartD": $("#img-d").attr("src"),
      "JsonChartW": $("#img-w").attr("src"),
      "JsonChartNDQCD": $("#img-ndqc-d").attr("src"),
      "JsonChartNDQCW": $("#img-ndqc-w").attr("src"),
      "JsonChartSP5D": $("#img-sp5-d").attr("src"),
      "JsonChartSP5W": $("#img-sp5-w").attr("src"),
      "JsonChartNYCD": $("#img-nyc-d").attr("src"),
      "JsonChartNYCW": $("#img-nyc-w").attr("src"),
      "JsonChartDJIAD": $("#img-djia-d").attr("src"),
      "JsonChartDJIAW": $("#img-djia-w").attr("src"),
      "JsonChartRUSD": $("#img-rus-d").attr("src"),
      "JsonChartRUSW": $("#img-rus-w").attr("src"),
      "JsonIBDCheckup": $("#img-ibd").attr("src"),
    };

    if (sell) {
      data.Revenue = revenue;
      data.Profit = profit;
      data.Gain = gain;
      data.DayHold = dayhold;
    }

    var jsonBody = JSON.stringify(data);

    processing = true;

    $.ajax({
      type: "POST",
      url: "/transaction",
      data: jsonBody,
      success: function(data) {
        window.location = data;
        processing = false;
      },
      error: function(xhr, err) {
        console.log(err);
        processing = false;
      },
    });

  });

  function imgChange(target) {
    var button = "#button-img-" + target;
    var inputs = "#input-img-" + target;
    var img = "#img-" + target;

    $(button).click(function() {
      $(inputs).click();
    });

    $(inputs).change(function() {
      fileChanged($(inputs), $(img));
    });
  }

  imgChange("d");
  imgChange("w");

  imgChange("ndqc-d");
  imgChange("ndqc-w");

  imgChange("sp5-d");
  imgChange("sp5-w");

  imgChange("nyc-d");
  imgChange("nyc-w");

  imgChange("djia-d");
  imgChange("djia-w");

  imgChange("rus-d");
  imgChange("rus-w");

  imgChange("ibd");
</script>

{{end}}
